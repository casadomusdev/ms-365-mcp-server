# Dry-Run Mode (Mock Graph API)

Dry-run mode lets you exercise all tools without calling Microsoft Graph. Responses are generated by a structured mock module and can be overridden from a JSON file.

## Enable

Two ways to enable dry-run:

```bash
# 1) Full mock mode (uses overrides + defaults)
MS365_MCP_DRYRUN_FILE=./mocks.json

# 2) Partial mode (reads go to live Graph; writes are simulated)
MS365_MCP_DRYRUN=true
```

Optional:

- `MS365_MCP_DRYRUN_FILE`: path to a JSON overrides file
- `MS365_MCP_DRYRUN_SEED`: number to make IDs/timestamps deterministic (default 42)

Example:

```bash
MS365_MCP_DRYRUN_FILE=./mocks.json
MS365_MCP_DRYRUN_SEED=1337
```

## Modes

- Mock mode (preferred): If `MS365_MCP_DRYRUN_FILE` points to a readable file, all requests are served by the mock layer (`src/mock/*`). No calls to Microsoft Graph are made.
- Partial mode: If `MS365_MCP_DRYRUN=true` and no valid overrides file is present, read-only requests (GET) go to live Microsoft Graph; mutating requests (POST/PUT/PATCH/DELETE) are suppressed and acknowledged safely (no side effects).
- Off: Neither of the above is set.

## What it does

All Graph requests are intercepted centrally in `src/graph-client.ts`.
- In mock mode, requests are routed to `src/mock/` and a Response-like object is returned.
- In partial mode, GET requests pass through to real Graph; non-GET mutations are intercepted and a Response-like success is returned (POST/PUT/PATCH → 202, DELETE → 204).

## Structure

- `src/mock/MockResponse.ts`: minimal Response-like class
- `src/mock/pathMatcher.ts`: match patterns like `/users/:userId/messages`
- `src/mock/registry.ts`: in-memory registry (`registerMock`, `find`)
- `src/mock/defaults.ts`: built-in two-user dataset (mail + calendar) with safe write statuses
- `src/mock/loader.ts`: loads overrides from `MS365_MCP_DRYRUN_FILE`
- `src/mock/index.ts`: enable/initialize, mode detection, and `mockFetch()`

## Defaults

The built-in defaults provide a small, deterministic dataset for two users:
- a.viets@casadomus.de (“A …” subjects for mail and events)
- b.viets@casadomus.de (“B …” subjects for mail and events)

- Mail:
  - `/me/messages`, `/users/:userId/messages`
- Calendar:
  - `/me/events`, `/users/:userId/events`, and `/me/calendars/:calendarId/events`
- Users (listing two): `/users`
- Writes are safe: POST → 202 Accepted, DELETE → 204 No Content

Impersonation-aware behavior in dry-run:
- If `MS365_MCP_IMPERSONATE_USER` is set:
  - `/me/...` returns only that user’s data
  - `/users/:userId/...` returns that userId’s data
- If impersonation is NOT set:
  - `/me/...` returns a combined dataset (both A and B)
  - `/users/:userId/...` still returns that userId’s data

User-agnostic fallback:
- If a `/users/:userId/...` mock is not present but a corresponding `/me/...` mock exists, dry-run will fallback to the `/me/...` mock automatically. This makes mocks work regardless of the impersonated user or route variant.

Overrides precedence:
- Overrides loaded from `MS365_MCP_DRYRUN_FILE` take precedence over built-in defaults.

Unknown endpoints fall back to:

- GET → `{ "value": [] }` (200)
- POST → empty body (202 Accepted)
- DELETE → empty body (204 No Content)
- Others → `{ "success": true }` (200)

## Impersonation and path rewriting

- In application-permissions mode, `/me/...` is rewritten to `/users/{impersonated}/...` when `MS365_MCP_IMPERSONATE_REWRITE_ME=true` (default).
- In mock mode, if impersonation is NOT configured, `/me/...` is allowed through so mocks can respond (no rewrite error).
- In partial mode, normal rewrite/error behavior applies (no special allowance for `/me`).
- Dry-run also provides `/users → /me` fallback as described above.

## Overrides file format

Reference file via `MS365_MCP_DRYRUN_FILE`. Keys are `"METHOD /path/pattern"`.

```json
{
  "GET /me": { "displayName": "Dry Run User", "userPrincipalName": "dryrun@example.com", "id": "00000000-0000-0000-0000-000000000000" },
  "GET /users/:userId/messages": { "value": [{ "id": "m1", "subject": "Hello" }] },
  "POST /users/:userId/sendMail": { "status": 202 }
}
```

Value can be:

- JSON object/array → becomes response body, 200 OK
- Object with `status`, optional `headers`, and `body`

## Docker usage

- docker-compose mounts the repo `./mocks.json` into the container at `/app/mocks.json`:
  ```
  volumes:
    - ./mocks.json:/app/mocks.json:ro
  ```
- And sets defaults:
  ```
  MS365_MCP_DRYRUN=${MS365_MCP_DRYRUN:-false}
  MS365_MCP_DRYRUN_FILE=${MS365_MCP_DRYRUN_FILE:-/app/mocks.json}
  ```
- Enable in `.env`:
  ```
  # Mock mode
  MS365_MCP_DRYRUN_FILE=/app/mocks.json
  # Partial mode (if no file above)
  MS365_MCP_DRYRUN=true
  # Optional impersonation
  MS365_MCP_IMPERSONATE_USER=a.viets@casadomus.de
  MS365_MCP_IMPERSONATE_REWRITE_ME=true
  ```

## Notes

- The mock layer returns Response-like objects (status, statusText, ok, headers.get, text). No changes needed in tools.
- Logs include a `[DRYRUN:MOCK]` prefix in mock mode (matches, fallbacks, overrides). A startup banner logs `[DRYRUN] active` with `{ mode }` when enabled.
- In partial mode, suppressed mutations log with `[DRYRUN:PARTIAL]` and include `method`, `path`, `status`, `impersonated`, and `bodySize`.


