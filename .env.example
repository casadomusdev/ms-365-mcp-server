# Docker Compose Project Name (used for container/network/volume naming)
COMPOSE_PROJECT_NAME=ms365-mcp

# HTTP Mode Port (only used when --http mode is enabled via command override in docker-compose.yaml)
# Default: 3000
# Uncomment and set a custom port if needed (e.g., to avoid port conflicts)
# MS365_MCP_HTTP_PORT=3000

# Organization Mode (REQUIRED for M365 Business - enables shared mailboxes, Teams, SharePoint)
MS365_MCP_ORG_MODE=true

# Optional: Log level (debug, info, warn, error)
MS365_MCP_LOG_LEVEL=info

# Microsoft 365 OAuth Configuration
# Create an Azure AD app registration and get these values:

# Your Azure AD App Registration Client ID (REQUIRED)
MS365_MCP_CLIENT_ID=

# Your Azure AD App Registration Client Secret (OPTIONAL)
# If set, the server will use CLIENT CREDENTIALS FLOW (application permissions)
# If not set, the server will use DEVICE CODE FLOW (delegated permissions)
# 
# CLIENT CREDENTIALS MODE:
# - No user login required
# - Uses application-level permissions
# - Access to ALL mailboxes in tenant (app has permission to access everything)
# - Requires Application Permissions in Azure AD (not Delegated)
# - Must grant admin consent in Azure AD
# 
# DEVICE CODE MODE (default):
# - Requires interactive user login
# - Uses user-level permissions
# - Access limited to what the signed-in user can access
# - Requires Delegated Permissions in Azure AD
MS365_MCP_CLIENT_SECRET=

# Tenant ID - use "common" for multi-tenant or your specific tenant ID
# For client credentials mode, you MUST use your specific tenant ID
MS365_MCP_TENANT_ID=

# Feature toggles for tool groups
MS365_MCP_ENABLE_MAIL=true
MS365_MCP_ENABLE_CALENDAR=true
MS365_MCP_ENABLE_FILES=false            # OneDrive + SharePoint
MS365_MCP_ENABLE_TEAMS=false            # Chats + Channels
MS365_MCP_ENABLE_EXCEL_POWERPOINT=false
MS365_MCP_ENABLE_ONENOTE=false
MS365_MCP_ENABLE_TASKS=false            # To Do + Planner
MS365_MCP_ENABLE_CONTACTS=false
MS365_MCP_ENABLE_USER=false
MS365_MCP_ENABLE_SEARCH=false
MS365_MCP_ENABLE_AUTH_TOOLS=true        # auth tools of this mcp (not MS365)

MS365_MCP_DRYRUN=true

#if no file is selected, dryruns will return real data
MS365_MCP_DRYRUN_FILE= # ./mocks.json (optional) Contains result info for dryruns
MS365_MCP_DRYRUN_SEED=42 #(optional)

# REQUIRED when using impersonation:
# The email (UPN) that all Graph requests should run as.
MS365_MCP_IMPERSONATE_USER=a.viets@casadomus.de
MS365_MCP_IMPERSONATE_REWRITE_ME=true #Rewrites /me to /users/{id}, true by default

#debug for debug, info for normal
MS365_MCP_LOG_LEVEL=debug
MS365_MCP_HTTP_LOG_PREVIEW=4000

# Enable debug-only previews/log details. When true, request/response previews are logged at debug level.
MS365_MCP_DEBUG=false

# Comma-separated HTTP origin allowlist for the /mcp endpoint.
# Example: https://openwebui.local,https://mcp.mycorp.com
# Empty = allow all (useful for local/dev only).
MS365_MCP_CORS_ORIGINS=

# Rate-limit window (ms) for /mcp requests per client IP.
MS365_MCP_RATE_LIMIT_WINDOW_MS=60000

# Max requests per IP within the window for /mcp.
MS365_MCP_RATE_LIMIT_MAX=60

# Hard cap on text content size returned by tools (characters). Larger payloads are truncated and flagged in _meta.
MS365_MCP_TEXT_CAP=200000

# OPTIONAL: Cache TTL (seconds) for the allowed mailbox set (impersonated + allowlist).
# - Lower values refresh more often; higher values reduce lookups.
# - Default: 3600 (1 hour).
#MS365_MCP_IMPERSONATE_CACHE_TTL=3600

# OPTIONAL: Header name to support per-request impersonation (email in header).
# - Only trust from a reverse proxy you control; clients should NOT set this directly.
# - If OpenWebUI doesn’t send this (current state), it will be ignored; env value is used.
# - Default is X-Impersonate-User; change only if your proxy uses a different header.
#MS365_MCP_IMPERSONATE_HEADER=X-Impersonate-User

# OPTIONAL: Extra logging for impersonation flows (request resolution, rewrites, enforced userId).
# - Set to true/1 to enable.
#MS365_MCP_IMPERSONATE_DEBUG=false


# OPTIONAL: Enable optional user validation before impersonation
# - When enabled, validates that the user exists in the tenant via Graph API before allowing impersonation
# - Helps catch typos and invalid email addresses early
# - Results are cached to minimize API calls
# - Default: false (disabled)
#MS365_MCP_VALIDATE_IMPERSONATION_USER=false

# OPTIONAL: Cache TTL (seconds) for user validation results
# - How long to cache validation results (valid/invalid users)
# - Default: 3600 (1 hour)
#MS365_MCP_USER_VALIDATION_TTL=3600

# OPTIONAL: Rewrite /me → /users/{impersonated} when running with app permissions.
# - Prevents Graph 400 errors for /me in client-credentials mode.
# - true: auto-rewrite (recommended); false: block /me with a clear config error.
#MS365_MCP_IMPERSONATE_REWRITE_ME=true

# ===========================
# PowerShell Integration (for Shared Mailbox Discovery)
# ===========================

# OPTIONAL: Enable/disable PowerShell-based shared mailbox discovery
# - Default: ENABLED (enabled unless explicitly set to false)
# - When enabled, automatically detects if 'pwsh' is available on system
# - If pwsh not found, gracefully falls back to personal mailbox only (with warning)
# - Uses Exchange Online PowerShell to query mailbox delegation permissions (Full Access, SendAs)
# - Uses certificate-based authentication (app-only access)
# - To disable: Set to 'false' or '0'
#MS365_POWERSHELL_ENABLED=true

# OPTIONAL: Timeout for PowerShell operations (milliseconds)
# - How long to wait for PowerShell commands to complete
# - Default: 30000 (30 seconds)
#MS365_POWERSHELL_TIMEOUT=30000

# REQUIRED for PowerShell: Organization domain name
# - Your primary Microsoft 365 tenant domain (e.g., contoso.onmicrosoft.com)
# - NOT the tenant ID GUID! Must be the actual domain name
# - Find it in Azure AD → Overview → Primary domain or <tenant-name>.onmicrosoft.com
#MS365_MCP_ORGANIZATION=

# PowerShell Certificate Setup:
# - Generate with: ./auth-generate-cert.sh
# - Upload public key (.cer) to Azure AD → App registrations → Certificates & secrets
# - Certificate files stored in: ./certs/ms365-powershell.pfx (auto-discovered)
# - Password stored in: ./certs/.cert-password.txt (auto-discovered)
# - No environment variables needed - PowerShellService auto-discovers from ./certs/
