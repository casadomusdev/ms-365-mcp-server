# ============================================================================
# MODE SELECTION - STDIO vs HTTP
# ============================================================================
# 
# 1. STDIO MODE (Default - Recommended for local/simple setups)
#    • Use with docker-mcp-wrapper.sh for Claude Desktop integration
#    • Use for simple container-to-container via docker exec
#    • Command: node dist/index.js (default, already set in Dockerfile)
#    • Security: ✅ Maximum - no network exposure
#    • Setup: No changes needed - works out of the box
#
# 2. HTTP MODE - SHARED NETWORK (Recommended for HTTP - Most Secure)
#    • MCP client container joins same Docker network as this server
#    • Client accesses server via: http://ms365-mcp-server:${MCP_HTTP_PORT}
#    • NO port mapping to host - internal Docker network only
#    • Security: ✅ Secure - network isolated, no host exposure
#    • Best for: Multi-container applications, microservices
#    
#    To enable HTTP mode on shared network:
#      a) Uncomment the 'command:' line in the HTTP MODE section below
#      b) Keep 'ports:' section COMMENTED (no host exposure)
#      c) Client container must join 'ms365-mcp-net' network or shared network
#      d) Optionally set MCP_HTTP_PORT in .env (default: 3000)
#      e) Restart: docker compose down && docker compose up -d
#
# 3. HTTP MODE - PORT EXPOSED (Only if external access required)
#    • Exposes HTTP port to host machine (localhost only)
#    • Use ONLY for: MCP Inspector, local testing, or external tools
#    • Security: ⚠️ Lower - port accessible on host (localhost only)
#    
#    To enable HTTP mode with port exposure:
#      a) Uncomment the 'command:' line in the HTTP MODE section below
#      b) Uncomment the 'ports:' section in the HTTP MODE section below
#      c) Set MCP_HTTP_PORT in .env if needed (default: 3000)
#      d) Restart: docker compose down && docker compose up -d
#
# ============================================================================

services:
  ms365-mcp:
    container_name: ${COMPOSE_PROJECT_NAME:-ms365-mcp}-server
    networks:
      - ms365-mcp-net
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    
    # === HTTP MODE CONFIGURATION ===
    # Uncomment the following line to enable HTTP mode (for both shared network and port exposure):
    # command: ["node", "dist/index.js", "--http", "${MS365_MCP_HTTP_PORT:-3000}"]
    
    # === PORT EXPOSURE (Only for Mode 3 - External Access) ===
    # Uncomment ONLY if you need to expose HTTP to host machine:
    # ports:
    #   - "127.0.0.1:${MS365_MCP_HTTP_PORT:-3000}:${MS365_MCP_HTTP_PORT:-3000}"
    
    # Environment variables with fallback defaults
    environment:
      # HTTP Mode Port (only used when HTTP mode is enabled via command override)
      MS365_MCP_HTTP_PORT: ${MS365_MCP_HTTP_PORT:-3000}
      
      # Azure AD App Configuration
      MS365_MCP_CLIENT_ID: ${MS365_MCP_CLIENT_ID:-}
      MS365_MCP_CLIENT_SECRET: ${MS365_MCP_CLIENT_SECRET:-}
      MS365_MCP_TENANT_ID: ${MS365_MCP_TENANT_ID:-}
      MS365_MCP_REFRESH_TOKEN: ${MS365_MCP_REFRESH_TOKEN:-}
      MS365_MCP_REDIRECT_URI: ${MS365_MCP_REDIRECT_URI:-}
      MS365_MCP_REDIRECT_URI_ENCODED: ${MS365_MCP_REDIRECT_URI_ENCODED:-}
      
      # Organization Mode (REQUIRED for M365 Business features)
      MS365_MCP_ORG_MODE: ${MS365_MCP_ORG_MODE:-true}
      
      # Feature Toggles
      MS365_MCP_ENABLE_MAIL: ${MS365_MCP_ENABLE_MAIL:-true}
      MS365_MCP_ENABLE_CALENDAR: ${MS365_MCP_ENABLE_CALENDAR:-true}
      MS365_MCP_ENABLE_FILES: ${MS365_MCP_ENABLE_FILES:-false}
      MS365_MCP_ENABLE_TEAMS: ${MS365_MCP_ENABLE_TEAMS:-false}
      MS365_MCP_ENABLE_EXCEL_POWERPOINT: ${MS365_MCP_ENABLE_EXCEL_POWERPOINT:-false}
      MS365_MCP_ENABLE_ONENOTE: ${MS365_MCP_ENABLE_ONENOTE:-false}
      MS365_MCP_ENABLE_TASKS: ${MS365_MCP_ENABLE_TASKS:-false}
      
      # Logging
      MS365_MCP_LOG_LEVEL: ${MS365_MCP_LOG_LEVEL:-info}
    
    # Mount volume for persistent token cache
    volumes:
      - token-cache:/app/data
    
    # Optional: Resource limits
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M
    
    # Keep container running in STDIO mode
    stdin_open: true
    tty: true
    
    # Enable automatic log rotation
    logging:
      driver: local

volumes:
  token-cache:
    driver: local
    name: ${COMPOSE_PROJECT_NAME:-ms365-mcp}-token-cache

networks:
  ms365-mcp-net:
    driver: bridge
    name: ${COMPOSE_PROJECT_NAME:-ms365-mcp}-net
