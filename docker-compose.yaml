# ============================================================================
# MODE SELECTION - STDIO vs HTTP
# ============================================================================
# 
# 1. STDIO MODE (Default - Recommended for local/simple setups)
#    • Use with docker-mcp-wrapper.sh for Claude Desktop integration
#    • Use for simple container-to-container via docker exec
#    • Command: node dist/index.js (default, already set in Dockerfile)
#    • Security: ✅ Maximum - no network exposure
#    • Setup: No changes needed - works out of the box
#
# 2. HTTP MODE - SHARED NETWORK (Recommended for HTTP - Most Secure)
#    • MCP client container joins same Docker network as this server
#    • Client accesses server via: http://ms365-mcp-server:${MCP_HTTP_PORT}
#    • NO port mapping to host - internal Docker network only
#    • Security: ✅ Secure - network isolated, no host exposure
#    • Best for: Multi-container applications, microservices
#    
#    To enable HTTP mode on shared network:
#      a) Uncomment the 'command:' line in the HTTP MODE section below
#         - Include --enable-auth-tools if you want auth-related MCP tools
#           (e.g. list-impersonated-mailboxes) available to LLM clients.
#      b) Keep 'ports:' section COMMENTED (no host exposure)
#      c) Client container must join 'ms365-mcp-net' network or shared network
#      d) Optionally set MCP_HTTP_PORT in .env (default: 3000)
#      e) Restart: docker compose down && docker compose up -d
#
# 3. HTTP MODE - PORT EXPOSED (Only if external access required)
#    • Exposes HTTP port to host machine (localhost only)
#    • Use ONLY for: MCP Inspector, local testing, or external tools
#    • Security: ⚠️ Lower - port accessible on host (localhost only)
#    
#    To enable HTTP mode with port exposure:
#      a) Uncomment the 'command:' line in the HTTP MODE section below
#      b) Uncomment the 'ports:' section in the HTTP MODE section below
#      c) Set MCP_HTTP_PORT in .env if needed (default: 3000)
#      d) Restart: docker compose down && docker compose up -d
#
# ============================================================================

services:
  ms365-mcp:
    container_name: ${COMPOSE_PROJECT_NAME:-ms365-mcp}-server
    networks:
      - ms365-mcp-net
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    
    # === HTTP MODE CONFIGURATION ===
    # This starts the MCP server in HTTP mode on MS365_MCP_HTTP_PORT.
    # NOTE: --enable-auth-tools is required so auth-related MCP tools (including
    #       list-impersonated-mailboxes) are registered and visible to LLM clients.
    #       Without this flag, auth tools are disabled by default in HTTP mode.
    #       Set MS365_MCP_ENABLE_AUTH_TOOLS=true in .env to enable auth tools.
    command: ["sh", "-c", "case \"${MS365_MCP_ENABLE_AUTH_TOOLS:-false}\" in true|1|yes|on) AUTH_FLAG=\"--enable-auth-tools\" ;; *) AUTH_FLAG=\"\" ;; esac; node dist/index.js --http ${MS365_MCP_HTTP_PORT:-3000} -v $AUTH_FLAG"]
    # === PORT EXPOSURE (Only for Mode 3 - External Access) ===
    # Uncomment ONLY if you need to expose HTTP to host machine:a
    ports:
      - "127.0.0.1:${MS365_MCP_HTTP_PORT:-3000}:${MS365_MCP_HTTP_PORT:-3000}"
    
    # Environment variables with fallback defaults
    environment:
      # HTTP Mode Port (only used when HTTP mode is enabled via command override)
      MS365_MCP_HTTP_PORT: ${MS365_MCP_HTTP_PORT:-3000}
      
      # Azure AD App Configuration
      MS365_MCP_CLIENT_ID: ${MS365_MCP_CLIENT_ID:-}
      MS365_MCP_CLIENT_SECRET: ${MS365_MCP_CLIENT_SECRET:-}
      MS365_MCP_TENANT_ID: ${MS365_MCP_TENANT_ID:-}
      MS365_MCP_REFRESH_TOKEN: ${MS365_MCP_REFRESH_TOKEN:-}
      MS365_MCP_REDIRECT_URI: ${MS365_MCP_REDIRECT_URI:-}
      MS365_MCP_REDIRECT_URI_ENCODED: ${MS365_MCP_REDIRECT_URI_ENCODED:-}
      
      # Organization Mode (REQUIRED for M365 Business features)
      MS365_MCP_ORG_MODE: ${MS365_MCP_ORG_MODE:-true}
      
      # Feature Toggles
      MS365_MCP_ENABLE_MAIL: ${MS365_MCP_ENABLE_MAIL:-true}
      MS365_MCP_ENABLE_CALENDAR: ${MS365_MCP_ENABLE_CALENDAR:-true}
      MS365_MCP_ENABLE_FILES: ${MS365_MCP_ENABLE_FILES:-false}
      MS365_MCP_ENABLE_TEAMS: ${MS365_MCP_ENABLE_TEAMS:-false}
      MS365_MCP_ENABLE_EXCEL_POWERPOINT: ${MS365_MCP_ENABLE_EXCEL_POWERPOINT:-false}
      MS365_MCP_ENABLE_ONENOTE: ${MS365_MCP_ENABLE_ONENOTE:-false}
      MS365_MCP_ENABLE_TASKS: ${MS365_MCP_ENABLE_TASKS:-false}
      
      # Logging
      MS365_MCP_LOG_LEVEL: ${MS365_MCP_LOG_LEVEL:-info}
      # Debug switch for verbose previews/logs (guards debug-only logs)
      MS365_MCP_DEBUG: ${MS365_MCP_DEBUG:-false}
      
      # HTTP Security (only relevant in HTTP mode)
      # Comma-separated allowlist of origins permitted to call /mcp (empty = allow all; dev only)
      MS365_MCP_CORS_ORIGINS: ${MS365_MCP_CORS_ORIGINS:-}
      # Basic per-IP rate limiting for /mcp
      MS365_MCP_RATE_LIMIT_WINDOW_MS: ${MS365_MCP_RATE_LIMIT_WINDOW_MS:-60000}
      MS365_MCP_RATE_LIMIT_MAX: ${MS365_MCP_RATE_LIMIT_MAX:-60}
      
      # Dry-run support (defaults allow using /app/mocks.json inside the container)
      MS365_MCP_DRYRUN: ${MS365_MCP_DRYRUN:-false}
      MS365_MCP_DRYRUN_FILE: ${MS365_MCP_DRYRUN_FILE:-/app/mocks.json}
      
      # Response size guard: hard cap on text content (characters)
      MS365_MCP_TEXT_CAP: ${MS365_MCP_TEXT_CAP:-200000}
      
      # Impersonation (Client Credentials Mode)
      # Impersonated identity (email/UPN). If unset and no trusted header is present, impersonation is disabled.
      MS365_MCP_IMPERSONATE_USER: ${MS365_MCP_IMPERSONATE_USER:-}
      # Header name used for per-request impersonation (email/UPN). Only trust via a reverse proxy.
      MS365_MCP_IMPERSONATE_HEADER: ${MS365_MCP_IMPERSONATE_HEADER:-X-Impersonate-User}
      # Optional comma-separated list of additional mailboxes allowed for the impersonated user.
      MS365_MCP_IMPERSONATE_ALLOWED_MAILBOXES: ${MS365_MCP_IMPERSONATE_ALLOWED_MAILBOXES:-}
      # Cache TTL (seconds) for mailbox discovery/allowlist (Phase 0 uses env allowlist only).
      MS365_MCP_IMPERSONATE_CACHE_TTL: ${MS365_MCP_IMPERSONATE_CACHE_TTL:-3600}
      # Rewrite /me → /users/{impersonated} in app-permissions mode to avoid Graph 400s.
      MS365_MCP_IMPERSONATE_REWRITE_ME: ${MS365_MCP_IMPERSONATE_REWRITE_ME:-true}
      # Extra logging for impersonation resolution and enforcement.
      MS365_MCP_IMPERSONATE_DEBUG: ${MS365_MCP_IMPERSONATE_DEBUG:-false}
    
    # Mount volume for persistent token cache
    volumes:
      - token-cache:/app/data
      # Mount repository mocks.json into the container for dry-run overrides
      - ./mocks.json:/app/mocks.json:ro
    
    # Optional: Resource limits
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M
    
    # Keep container running in STDIO mode
    stdin_open: true
    tty: true
    
    # Enable automatic log rotation
    logging:
      driver: local

volumes:
  token-cache:
    driver: local
    name: ${COMPOSE_PROJECT_NAME:-ms365-mcp}-token-cache

networks:
  ms365-mcp-net:
    driver: bridge
    name: ${COMPOSE_PROJECT_NAME:-ms365-mcp}-net
